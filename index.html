<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OneStop Bets – Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Important for SPAs on Netlify so deep links don't 404 -->
  <base href="/" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#222; --muted:#6b7280; --brand:#0ea5e9;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --border:#e5e7eb;
      --chip:#eef6ff; --chip-ink:#0f3a7a;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink); background:var(--bg);
    }
    header{
      position:sticky; top:0; z-index:30;
      background:#fff; border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{display:inline-grid;grid-auto-flow:column;gap:4px;align-items:center}
    .logo b{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:7px;font-size:14px}
    .logo b:nth-child(1){background:#0ea5e91a;color:#075985}
    .logo b:nth-child(2){background:#22c55e1a;color:#065f46}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    select,input[type="date"]{height:36px;border:1px solid var(--border);border-radius:10px;padding:0 10px;background:#fff}
    button.btn{height:36px;border:none;border-radius:10px;padding:0 12px;background:var(--brand);color:#fff;cursor:pointer}
    .status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .status.ok::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--ok)}
    .grid{display:grid;grid-template-columns:1fr 1.5fr;gap:16px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:0 1px 2px rgba(0,0,0,.04); overflow:hidden;
    }
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:14px;letter-spacing:.02em}
    .events{padding:8px}
    .event{
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px;
      cursor:pointer; transition:transform .05s ease, box-shadow .15s ease; 
    }
    .event:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(2,6,23,.06)}
    .event-title{font-weight:600}
    .event-meta{display:flex;gap:10px;margin-top:6px;color:var(--muted);font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border)}
    .details{padding:10px}
    .hint{color:var(--muted);font-size:14px}
    .book-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .book{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff;
    }
    .book h4{margin:0 0 6px 0;font-size:13px}
    .line{display:flex;justify-content:space-between;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .chip{display:inline-block;background:var(--chip);color:var(--chip-ink);border-radius:999px;padding:2px 8px;font-size:12px}
    .toolbar{
      position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--border);
    }
    .tabs{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:repeat(7,1fr)}
    .tab{padding:12px 8px;text-align:center;color:#111827;cursor:pointer}
    .tab:hover{background:#fafafa}
    .sr-only{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-label="OneStop Bets">
          <b>OS</b><b>B</b>
        </div>
        <h1>OneStop Bets – Preview</h1>
      </div>

      <div class="controls">
        <label>Sport:
          <select id="sport">
            <option value="2" selected>NFL</option>
            <option value="4">NBA</option>
            <option value="3">MLB</option>
          </select>
        </label>
        <label>Date:
          <input id="date" type="date" />
        </label>
        <button id="refresh" class="btn">Refresh</button>
        <span id="apiStatus" class="status">Checking API…</span>
        <span class="status">API: /api/public</span>
      </div>
    </div>
  </header>

  <main class="wrap" id="app" aria-live="polite">
    <section aria-labelledby="today">
      <h2 id="today" class="sr-only">Today’s edges</h2>
      <div class="grid">
        <div class="card">
          <h3>EVENTS</h3>
          <div id="events" class="events"></div>
        </div>

        <div class="card">
          <h3>DETAILS</h3>
          <div id="details" class="details">
            <p class="hint">Select an event to view books &amp; lines.</p>
          </div>
        </div>
      </div>
    </section>
    <br/><br/>
  </main>

  <nav class="toolbar" aria-label="Bottom">
    <div class="tabs">
      <div class="tab">Home</div>
      <div class="tab">Bet Builder</div>
      <div class="tab">Activity</div>
      <div class="tab">Experts</div>
      <div class="tab">News</div>
      <div class="tab">Stats</div>
      <div class="tab" id="promoTab">Promo</div>
    </div>
  </nav>

  <script>
    // --- Config ---
    const API = '/api/public'; // goes through Netlify redirect

    // --- Helpers ---
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') node.className = v;
        else if (k === 'html') node.innerHTML = v;
        else node.setAttribute(k, v);
      });
      children.forEach(c => node.append(c));
      return node;
    };
    const fmtTime = iso => {
      const d = new Date(iso);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    };
    const todayInput = () => {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };

    // --- API pings / status ---
    async function checkApi(){
      const badge = $('#apiStatus');
      try{
        // a very light call (delta/start is fine with filters, but use events compact)
        const params = new URLSearchParams({sportId:2, date: $('#date').value, compact:'true'});
        const r = await fetch(`${API}/events?${params}`);
        if(!r.ok) throw new Error(`${r.status}`);
        badge.classList.add('ok');
        badge.textContent = 'ok';
      }catch(err){
        badge.classList.remove('ok');
        badge.textContent = `API error`;
      }
    }

    // --- Load events list ---
    async function loadEvents(){
      const sportId = $('#sport').value;
      const date = $('#date').value;
      const target = $('#events');
      target.innerHTML = '';
      const qs = new URLSearchParams({compact:'true', sportId, date});
      const res = await fetch(`${API}/events?${qs}`);
      if(!res.ok){
        target.append(el('div', {}, `Failed to load events (${res.status})`));
        return;
      }
      const data = await res.json();
      if(!data.events || data.events.length === 0){
        target.append(el('div', {}, 'No events for this date.'));
        return;
      }
      data.events.forEach(ev => {
        const node = el('div', {class:'event', tabindex:'0'});
        const title = el('div', {class:'event-title'}, `${ev.away_team} @ ${ev.home_team}`);
        const meta = el('div', {class:'event-meta'});
        meta.append(
          el('span', {class:'pill'}, (ev.status || '').replace('STATUS_','').replace('_',' ')),
          el('span', {}, fmtTime(ev.event_date))
        );
        node.append(title, meta);
        node.addEventListener('click', () => showEvent(ev.event_id, title.textContent));
        node.addEventListener('keypress', (e)=>{ if(e.key==='Enter') node.click(); });
        target.append(node);
      });
    }

    // --- Show event details (combined odds helper) ---
    async function showEvent(eventId, label){
      const box = $('#details');
      box.innerHTML = '';
      box.append(el('div', {class:'hint'}, `Loading odds for `, el('span',{class:'chip'}, label), ' …'));

      try{
        const qs = new URLSearchParams({include:'all_periods'});
        const res = await fetch(`${API}/events/${eventId}/odds/combined?${qs}`);
        if(!res.ok) throw new Error('Odds not available');
        const { event, note } = await res.json();

        box.innerHTML = '';
        box.append(
          el('div', {class:'hint'}, label),
          note ? el('p', {class:'hint'}, note) : null
        );

        // Render "Period Full Game" lines across affiliates if present
        const booksWrap = el('div', {class:'book-grid'});
        const lp = event?.line_periods || {};
        const affiliateIds = Object.keys(lp);
        if (affiliateIds.length === 0){
          box.append(el('p', {}, 'No book lines available.'));
          return;
        }

        affiliateIds.forEach(aid => {
          // The structure is lp[affiliateId].period_full_game.{moneyline/spread/total}
          const full = lp[aid]?.period_full_game;
          if (!full) return;
          const book = el('div', {class:'book'});
          const name = full.affiliate?.affiliate_name || `Book ${aid}`;
          book.append(el('h4', {}, name));

          // Moneyline
          if (full.moneyline){
            const ml = full.moneyline;
            book.append(
              el('div', {class:'line'},
                el('div', {}, 'ML Away'),
                el('div', {}, String(ml.moneyline_away))
              ),
              el('div', {class:'line'},
                el('div', {}, 'ML Home'),
                el('div', {}, String(ml.moneyline_home))
              )
            );
          }

          // Spread
          if (full.spread){
            const s = full.spread;
            book.append(
              el('div', {class:'line'},
                el('div', {}, 'Spread Away'),
                el('div', {}, `${s.point_spread_away} (${s.point_spread_away_money})`)
              ),
              el('div', {class:'line'},
                el('div', {}, 'Spread Home'),
                el('div', {}, `${s.point_spread_home} (${s.point_spread_home_money})`)
              )
            );
          }

          // Total
          if (full.total){
            const t = full.total;
            book.append(
              el('div', {class:'line'},
                el('div', {}, 'Total Over'),
                el('div', {}, `${t.total_over} (${t.total_over_money})`)
              ),
              el('div', {class:'line'},
                el('div', {}, 'Total Under'),
                el('div', {}, `${t.total_under} (${t.total_under_money})`)
              )
            );
          }

          booksWrap.append(book);
        });

        if (booksWrap.children.length === 0){
          box.append(el('p', {}, 'No full-game market lines available.'));
        } else {
          box.append(booksWrap);
        }
      }catch(err){
        box.innerHTML = '';
        box.append(el('p', {}, 'Could not load odds for this event.'));
      }
    }

    // --- Promo tab placeholder (so it never appears blank) ---
    $('#promoTab').addEventListener('click', () => {
      const box = $('#details');
      box.innerHTML = '';
      box.append(
        el('h3', {}, 'Promotions'),
        el('p', {class:'hint'}, 'Welcome offer cards would show here. Coming soon.')
      );
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // --- Boot ---
    (function init(){
      $('#date').value = todayInput();
      $('#refresh').addEventListener('click', () => { loadEvents(); checkApi(); });
      $('#sport').addEventListener('change', loadEvents);
      $('#date').addEventListener('change', () => { loadEvents(); checkApi(); });

      loadEvents();
      checkApi();
    })();
  </script>
</body>
</html>
